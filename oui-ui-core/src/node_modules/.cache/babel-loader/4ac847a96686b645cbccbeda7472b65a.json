{"remainingRequest":"D:\\Project VMODEV\\Horde\\oui\\oui-master\\oui-ui-core\\src\\node_modules\\babel-loader\\lib\\index.js!D:\\Project VMODEV\\Horde\\oui\\oui-master\\oui-ui-core\\src\\node_modules\\eslint-loader\\index.js??ref--13-0!D:\\Project VMODEV\\Horde\\oui\\oui-master\\oui-ui-core\\src\\src\\plugins\\uci.js","dependencies":[{"path":"D:\\Project VMODEV\\Horde\\oui\\oui-master\\oui-ui-core\\src\\src\\plugins\\uci.js","mtime":1591674512000},{"path":"D:\\Project VMODEV\\Horde\\oui\\oui-master\\oui-ui-core\\src\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Project VMODEV\\Horde\\oui\\oui-master\\oui-ui-core\\src\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\Project VMODEV\\Horde\\oui\\oui-master\\oui-ui-core\\src\\node_modules\\eslint-loader\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.regexp.to-string\";\nimport \"core-js/modules/es6.array.sort\";\nimport \"core-js/modules/es6.object.keys\";\nimport _toConsumableArray from \"D:\\\\Project VMODEV\\\\Horde\\\\oui\\\\oui-master\\\\oui-ui-core\\\\src\\\\node_modules\\\\@babel\\\\runtime-corejs2/helpers/esm/toConsumableArray\";\nimport \"core-js/modules/web.dom.iterable\";\nimport { session } from \"./session\";\nimport { ubus } from \"./ubus\";\nexport var uci = {\n  state: {\n    applying: false,\n    newidx: 0,\n    changed: 0,\n    values: {},\n    changes: {},\n    creates: {},\n    deletes: {},\n    reorder: {}\n  }\n};\nvar isEmptyArray = window.oui.isEmptyArray;\n\nuci.load = function (conf) {\n  var _this = this;\n\n  return new Promise(function (resolve) {\n    if (_this.state.values[conf]) {\n      resolve();\n      return;\n    }\n\n    ubus.call('uci', 'get', {\n      config: conf\n    }).then(function (r) {\n      _this.state.values[conf] = r.values;\n      resolve();\n    });\n  });\n};\n\nuci.sections = function (conf, type) {\n  var v = this.state.values[conf] || {};\n  var n = this.state.creates[conf] || {};\n  var d = this.state.deletes[conf] || {};\n  var sections = [];\n  sections.push.apply(sections, _toConsumableArray(Object.keys(v).map(function (sid) {\n    return v[sid];\n  }).filter(function (s) {\n    var sid = s['.name'];\n    if (d && d[sid]) return false;\n    return !type || s['.type'] === type;\n  })));\n  sections.push.apply(sections, _toConsumableArray(Object.keys(n).map(function (sid) {\n    return n[sid];\n  }).filter(function (s) {\n    return !type || s['.type'] === type;\n  })));\n  return sections.sort(function (a, b) {\n    return a['.index'] - b['.index'];\n  });\n};\n\nuci.get = function (conf, sid, opt) {\n  var v = this.state.values[conf];\n  var n = this.state.creates[conf];\n  var s = undefined;\n  if (typeof sid === 'undefined') return undefined;\n  if (n && n[sid]) s = n[sid];else if (v && v[sid]) s = v[sid];\n  if (typeof opt === 'undefined') return s;\n  return s && s[opt];\n};\n\nuci.set = function (conf, sid, opt, val) {\n  var v = this.state.values;\n  var c = this.state.changes;\n  var n = this.state.creates;\n  var d = this.state.deletes;\n  if (typeof sid === 'undefined' || typeof opt === 'undefined' || opt.charAt(0) === '.') return;\n\n  if (n[conf] && n[conf][sid]) {\n    if (typeof val !== 'undefined' && val !== '' && !isEmptyArray(val)) {\n      n[conf][sid][opt] = val;\n    } else {\n      delete n[conf][sid][opt];\n    }\n  } else if (typeof val !== 'undefined' && val !== '' && !isEmptyArray(val)) {\n    /* do not set within deleted section */\n    if (d[conf] && d[conf][sid] === true) return;\n    /* only set in existing sections */\n\n    if (!v[conf] || !v[conf][sid]) return;\n    if (!c[conf]) c[conf] = {};\n    if (!c[conf][sid]) c[conf][sid] = {};\n    /* undelete option */\n\n    if (d[conf] && d[conf][sid]) {\n      if (Array.isArray(d[conf][sid])) d[conf][sid].splice(d[conf][sid].indexOf(opt), 1);\n    }\n\n    c[conf][sid][opt] = val;\n    this.state.changed++;\n  } else {\n    /* only delete in existing sections */\n    if (!v[conf] || !v[conf][sid]) return;\n    if (!d[conf]) d[conf] = {};\n    if (!d[conf][sid]) d[conf][sid] = [];\n    if (d[conf][sid] !== true) d[conf][sid].push(opt);\n    this.state.changed++;\n  }\n};\n\nuci.createSID = function (conf) {\n  var v = this.state.values;\n  var n = this.state.creates;\n  var sid;\n\n  do {\n    sid = 'new' + parseInt((Math.random() * 0xFFFFFF).toFixed(0)).toString(16);\n  } while (n[conf] && n[conf][sid] || v[conf] && v[conf][sid]);\n\n  return sid;\n}, uci.add = function (conf, type, name) {\n  var n = this.state.creates;\n  var sid = name || this.createSID(conf);\n  if (!n[conf]) n[conf] = {};\n  n[conf][sid] = {\n    '.type': type,\n    '.name': sid,\n    '.create': name,\n    '.anonymous': !name,\n    '.index': 1000 + this.state.newidx++\n  };\n  return sid;\n};\n\nuci.del = function (conf, sid) {\n  var n = this.state.creates;\n  var c = this.state.changes;\n  var d = this.state.deletes;\n\n  if (n[conf] && n[conf][sid]) {\n    delete n[conf][sid];\n  } else {\n    if (c[conf]) delete c[conf][sid];\n    if (!d[conf]) d[conf] = {};\n    d[conf][sid] = true;\n  }\n};\n\nuci.swap = function (conf, sid1, sid2) {\n  var s1 = this.get(conf, sid1);\n  var s2 = this.get(conf, sid2);\n  var n1 = s1 ? s1['.index'] : NaN;\n  var n2 = s2 ? s2['.index'] : NaN;\n  if (isNaN(n1) || isNaN(n2)) return false;\n  s1['.index'] = n2;\n  s2['.index'] = n1;\n  this.state.reorder[conf] = true;\n  this.state.changed++;\n  return true;\n}, uci.changed = function () {\n  var changed = this.state.changed;\n  var n = this.state.creates;\n  var d = this.state.deletes;\n\n  for (var conf in n) {\n    changed += Object.keys(n[conf]).length;\n  }\n\n  for (var _conf in d) {\n    changed += Object.keys(d[_conf]).length;\n  }\n\n  return changed;\n};\n\nuci.reset = function () {\n  this.state.changes = {};\n  this.state.creates = {};\n  this.state.deletes = {};\n  this.state.reorder = {};\n  this.state.changed = 0;\n  this.state.newidx = 0;\n};\n\nuci.reorderSections = function () {\n  var v = this.state.values;\n  var n = this.state.creates;\n  var r = this.state.reorder;\n  var batch = [];\n  /*\n  ** gather all created and existing sections, sort them according\n  ** to their index value and issue an uci order call\n  */\n\n  for (var conf in r) {\n    var orders = [];\n\n    if (n[conf]) {\n      for (var s in n[conf]) {\n        orders.push(n[conf][s]);\n      }\n    }\n\n    for (var _s in v[conf]) {\n      orders.push(v[conf][_s]);\n    }\n\n    orders.sort(function (a, b) {\n      return a['.index'] - b['.index'];\n    });\n    var sids = orders.map(function (o) {\n      return o['.name'];\n    });\n    if (sids.length > 0) batch.push(['uci', 'order', {\n      config: conf,\n      sections: sids\n    }]);\n  }\n\n  return new Promise(function (resolve) {\n    if (batch.length === 0) {\n      resolve();\n      return;\n    }\n\n    ubus.callBatch(batch).then(function () {\n      resolve();\n    });\n  });\n};\n\nuci.save = function () {\n  var _this2 = this;\n\n  var c = this.state.changes;\n  var n = this.state.creates;\n  var d = this.state.deletes;\n  return new Promise(function (resolve) {\n    var batch = [];\n    var confs = {};\n\n    for (var conf in c) {\n      for (var sid in c[conf]) {\n        batch.push(['uci', 'set', {\n          config: conf,\n          section: sid,\n          values: c[conf][sid]\n        }]);\n      }\n\n      confs[conf] = true;\n    }\n\n    for (var _conf2 in n) {\n      for (var _sid in n[_conf2]) {\n        var params = {\n          config: _conf2,\n          values: {}\n        };\n\n        for (var k in n[_conf2][_sid]) {\n          if (k === '.type') params.type = n[_conf2][_sid][k];else if (k === '.create') params.name = n[_conf2][_sid][k];else if (k.charAt(0) !== '.') params.values[k] = n[_conf2][_sid][k];\n        }\n\n        batch.push(['uci', 'add', params]);\n      }\n\n      confs[_conf2] = true;\n    }\n\n    for (var _conf3 in d) {\n      for (var _sid2 in d[_conf3]) {\n        var options = d[_conf3][_sid2];\n        batch.push(['uci', 'delete', {\n          config: _conf3,\n          section: _sid2,\n          options: options === true ? undefined : options\n        }]);\n      }\n\n      confs[_conf3] = true;\n    }\n\n    if (batch.length === 0) {\n      _this2.reorderSections().then(function () {\n        _this2.reset();\n\n        for (var _conf4 in confs) {\n          delete _this2.state.values[_conf4];\n        }\n\n        resolve();\n      });\n\n      return;\n    }\n\n    ubus.callBatch(batch).then(function () {\n      _this2.reorderSections().then(function () {\n        _this2.reset();\n\n        for (var _conf5 in confs) {\n          delete _this2.state.values[_conf5];\n        }\n\n        resolve();\n      });\n    });\n  });\n};\n\nuci.apply = function (timeout, rollback) {\n  var state = this.state;\n  var date = new Date();\n  if (typeof timeout !== 'number' || timeout < 1) timeout = 10;\n  state.applying = true;\n  return new Promise(function (resolve, reject) {\n    ubus.call('uci', 'apply', {\n      rollback: rollback,\n      timeout: timeout\n    }).then(function () {\n      if (!rollback) {\n        state.applying = false;\n        resolve();\n        return;\n      }\n\n      var try_deadline = date.getTime() + 1000 * timeout;\n\n      var try_confirm = function try_confirm() {\n        ubus.call('uci', 'confirm').then(function () {\n          state.applying = false;\n          resolve();\n        }).catch(function (e) {\n          if (date.getTime() < try_deadline) {\n            window.setTimeout(try_confirm, 250);\n            return;\n          }\n\n          state.applying = false;\n          reject(e);\n        });\n      };\n\n      window.setTimeout(try_confirm, 1000);\n    }).catch(function (e) {\n      state.applying = false;\n      reject(e);\n    });\n  });\n};\n\nuci.applying = function () {\n  return this.state.applying;\n};\n\nuci.readable = function (conf) {\n  return session.hasACL('uci', conf, 'read');\n};\n\nuci.writable = function (conf) {\n  return session.hasACL('uci', conf, 'write');\n};\n\nexport default {\n  install: function install(Vue) {\n    Vue.prototype.$uci = uci;\n  }\n};",{"version":3,"sources":["D:\\Project VMODEV\\Horde\\oui\\oui-master\\oui-ui-core\\src\\src\\plugins\\uci.js"],"names":["session","ubus","uci","state","applying","newidx","changed","values","changes","creates","deletes","reorder","isEmptyArray","window","oui","load","conf","Promise","resolve","call","config","then","r","sections","type","v","n","d","push","Object","keys","map","sid","filter","s","sort","a","b","get","opt","undefined","set","val","c","charAt","Array","isArray","splice","indexOf","createSID","parseInt","Math","random","toFixed","toString","add","name","del","swap","sid1","sid2","s1","s2","n1","NaN","n2","isNaN","length","reset","reorderSections","batch","orders","sids","o","callBatch","save","confs","section","params","k","options","apply","timeout","rollback","date","Date","reject","try_deadline","getTime","try_confirm","catch","e","setTimeout","readable","hasACL","writable","install","Vue","prototype","$uci"],"mappings":"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","sourcesContent":["import {session} from './session'\nimport {ubus} from './ubus'\n\nexport const uci = {\n  state: {\n    applying: false,\n    newidx: 0,\n    changed: 0,\n    values: {},\n    changes: {},\n    creates: {},\n    deletes: {},\n    reorder: {}\n  }\n}\n\nconst isEmptyArray = window.oui.isEmptyArray\n\nuci.load = function(conf) {\n  return new Promise(resolve => {\n    if (this.state.values[conf]) {\n      resolve();\n      return;\n    }\n\n    ubus.call('uci', 'get', {config: conf}).then(r => {\n      this.state.values[conf] = r.values;\n      resolve();\n    });\n  });\n}\n\nuci.sections = function(conf, type) {\n  const v = this.state.values[conf] || {};\n  const n = this.state.creates[conf] || {};\n  const d = this.state.deletes[conf] || {};\n  const sections = [];\n\n  sections.push(...Object.keys(v).map(sid => v[sid]).filter(s => {\n    const sid = s['.name'];\n    if (d && d[sid])\n      return false;\n    return !type || s['.type'] === type;\n  }));\n  sections.push(...Object.keys(n).map(sid => n[sid]).filter(s => !type || s['.type'] === type));\n\n  return sections.sort((a, b) => a['.index'] - b['.index']);\n}\n\nuci.get = function(conf, sid, opt) {\n  const v = this.state.values[conf];\n  const n = this.state.creates[conf];\n  let s = undefined;\n\n  if (typeof(sid) === 'undefined')\n    return undefined;\n\n  if (n && n[sid])\n    s = n[sid];\n  else if (v && v[sid])\n    s = v[sid];\n\n  if (typeof(opt) === 'undefined')\n    return s;\n\n  return s && s[opt];\n}\n\nuci.set = function(conf, sid, opt, val) {\n  const v = this.state.values;\n  const c = this.state.changes;\n  const n = this.state.creates;\n  const d = this.state.deletes;\n\n  if (typeof(sid) === 'undefined' ||\n    typeof(opt) === 'undefined' ||\n    opt.charAt(0) === '.')\n    return;\n\n  if (n[conf] && n[conf][sid]) {\n    if (typeof(val) !== 'undefined' && val !== '' && !isEmptyArray(val)) {\n      n[conf][sid][opt] = val;\n    } else {\n      delete n[conf][sid][opt];\n    }\n  } else if (typeof(val) !== 'undefined' && val !== '' && !isEmptyArray(val)) {\n    /* do not set within deleted section */\n    if (d[conf] && d[conf][sid] === true)\n      return;\n\n    /* only set in existing sections */\n    if (!v[conf] || !v[conf][sid])\n      return;\n\n    if (!c[conf])\n      c[conf] = {};\n\n    if (!c[conf][sid])\n      c[conf][sid] = {};\n\n    /* undelete option */\n    if (d[conf] && d[conf][sid]) {\n      if (Array.isArray(d[conf][sid]))\n        d[conf][sid].splice(d[conf][sid].indexOf(opt), 1);\n    }\n\n    c[conf][sid][opt] = val;\n    this.state.changed++;\n  } else {\n    /* only delete in existing sections */\n    if (!v[conf] || !v[conf][sid])\n      return;\n\n    if (!d[conf])\n      d[conf] = {};\n\n    if (!d[conf][sid])\n      d[conf][sid] = [];\n\n    if (d[conf][sid] !== true)\n      d[conf][sid].push(opt);\n\n    this.state.changed++;\n  }\n}\n\nuci.createSID = function(conf) {\n  const v = this.state.values;\n  const n = this.state.creates;\n  let sid;\n\n  do {\n    sid = 'new' + parseInt((Math.random() * 0xFFFFFF).toFixed(0)).toString(16);\n  } while ((n[conf] && n[conf][sid]) || (v[conf] && v[conf][sid]));\n\n  return sid;\n},\n\nuci.add = function(conf, type, name) {\n  const n = this.state.creates;\n  const sid = name || this.createSID(conf);\n\n  if (!n[conf])\n    n[conf] = {};\n\n  n[conf][sid] = {\n    '.type': type,\n    '.name': sid,\n    '.create': name,\n    '.anonymous': !name,\n    '.index': 1000 + this.state.newidx++\n  };\n\n  return sid;\n}\n\nuci.del = function(conf, sid) {\n  const n = this.state.creates;\n  const c = this.state.changes;\n  const d = this.state.deletes;\n\n  if (n[conf] && n[conf][sid]) {\n    delete n[conf][sid];\n  } else {\n    if (c[conf])\n      delete c[conf][sid];\n\n    if (!d[conf])\n      d[conf] = {};\n\n    d[conf][sid] = true;\n  }\n}\n\nuci.swap = function(conf, sid1, sid2) {\n  const s1 = this.get(conf, sid1);\n  const s2 = this.get(conf, sid2);\n  const n1 = s1 ? s1['.index'] : NaN;\n  const n2 = s2 ? s2['.index'] : NaN;\n\n  if (isNaN(n1) || isNaN(n2))\n    return false;\n\n  s1['.index'] = n2;\n  s2['.index'] = n1;\n\n  this.state.reorder[conf] = true;\n  this.state.changed++;\n\n  return true;\n},\n\nuci.changed = function() {\n  let changed = this.state.changed;\n  const n = this.state.creates;\n  const d = this.state.deletes;\n\n  for (const conf in n)\n    changed += Object.keys(n[conf]).length;\n\n  for (const conf in d)\n    changed += Object.keys(d[conf]).length;\n\n  return changed;\n}\n\nuci.reset = function() {\n  this.state.changes = {};\n  this.state.creates = {};\n  this.state.deletes = {};\n  this.state.reorder = {};\n  this.state.changed = 0;\n  this.state.newidx = 0;\n}\n\nuci.reorderSections = function() {\n  const v = this.state.values;\n  const n = this.state.creates;\n  const r = this.state.reorder;\n\n  const batch = [];\n\n  /*\n  ** gather all created and existing sections, sort them according\n  ** to their index value and issue an uci order call\n  */\n  for (const conf in r) {\n    const orders = [];\n\n    if (n[conf]) {\n      for (const s in n[conf])\n        orders.push(n[conf][s]);\n    }\n\n    for (const s in v[conf])\n      orders.push(v[conf][s]);\n\n    orders.sort((a, b) => a['.index'] - b['.index']);\n    const sids = orders.map(o => o['.name']);\n\n    if (sids.length > 0)\n      batch.push(['uci', 'order', {config: conf, sections: sids}]);\n  }\n\n  return new Promise(resolve => {\n    if (batch.length === 0) {\n      resolve();\n      return;\n    }\n\n    ubus.callBatch(batch).then(() => {\n      resolve();\n    });\n  });\n}\n\nuci.save = function() {\n  const c = this.state.changes;\n  const n = this.state.creates;\n  const d = this.state.deletes;\n\n  return new Promise(resolve => {\n    const batch = [];\n    const confs = {};\n\n    for (const conf in c) {\n      for (const sid in c[conf])\n        batch.push(['uci', 'set', {config: conf, section: sid, values: c[conf][sid]}]);\n      confs[conf] = true;\n    }\n\n    for (const conf in n) {\n      for (const sid in n[conf]) {\n        const params = {config: conf, values: {}};\n        for (const k in n[conf][sid]) {\n          if (k === '.type')\n            params.type = n[conf][sid][k];\n          else if (k === '.create')\n            params.name = n[conf][sid][k];\n          else if (k.charAt(0) !== '.')\n            params.values[k] = n[conf][sid][k];\n        }\n        batch.push(['uci', 'add', params]);\n      }\n      confs[conf] = true;\n    }\n\n    for (const conf in d) {\n      for (const sid in d[conf]) {\n        const options = d[conf][sid];\n        batch.push(['uci', 'delete', {config: conf, section: sid, options: (options === true) ? undefined : options}]);\n      }\n      confs[conf] = true;\n    }\n\n    if (batch.length === 0) {\n      this.reorderSections().then(() => {\n        this.reset();\n        for (const conf in confs)\n          delete this.state.values[conf];\n        resolve();\n      });\n      return;\n    }\n\n    ubus.callBatch(batch).then(() => {\n      this.reorderSections().then(() => {\n        this.reset();\n        for (const conf in confs)\n          delete this.state.values[conf];\n        resolve();\n      });\n    });\n  });\n}\n\nuci.apply = function(timeout, rollback) {\n  const state = this.state;\n  const date = new Date();\n\n  if (typeof(timeout) !== 'number' || timeout < 1)\n    timeout = 10;\n\n  state.applying = true;\n\n  return new Promise((resolve, reject) => {\n    ubus.call('uci', 'apply', {rollback, timeout}).then(() => {\n      if (!rollback) {\n        state.applying = false;\n        resolve();\n        return;\n      }\n\n      const try_deadline = date.getTime() + 1000 * timeout;\n      const try_confirm = function() {\n        ubus.call('uci', 'confirm').then(() => {\n          state.applying = false;\n          resolve();\n        }).catch(e => {\n          if (date.getTime() < try_deadline) {\n            window.setTimeout(try_confirm, 250);\n            return;\n          }\n          state.applying = false;\n          reject(e);\n        });\n      };\n\n      window.setTimeout(try_confirm, 1000);\n    }).catch(e => {\n      state.applying = false;\n      reject(e);\n    });\n  });\n}\n\nuci.applying = function() {\n  return this.state.applying;\n}\n\nuci.readable = function(conf) {\n  return session.hasACL('uci', conf, 'read');\n}\n\nuci.writable = function(conf) {\n  return session.hasACL('uci', conf, 'write');\n}\n\nexport default {\n  install(Vue) {\n    Vue.prototype.$uci = uci;\n  }\n}\n"]}]}